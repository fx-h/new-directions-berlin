---
title: | 
    | Sensitivity Analyses
author: "Ryan T. Moore"
date: 2024-07-16
date-format: iso
execute: 
  echo: true
format: 
  beamer:
    fonttheme: serif
    include-in-header:
      - text: |
          \usepackage{wasysym}
          \newcommand{\independent}{\perp\mkern-9.5mu\perp}
    section-titles: true
    toc: true
institute:
  - American University
  - The Lab @ DC
bibliography: "../admin/main.bib"
---

```{r}
#| label: setup
#| echo: false
#| message: false
#| results: false
#| warning: false

library(ggdag)
library(here)
library(knitr)
library(scales)
library(tidyverse)
```

# Sensitivity

## What is "sensitivity"?

\LARGE

When inputs change, do outputs change?

\pause 

>- With different variables in model, does parameter of interest change?
>- With different assumptions about error structures, does causal mediation estimate change?
>- With different data collected, would causal conclusion change?

<!-- Include PDFs in columns -->
<!-- \includegraphics[width=2in]{figs/myfig1.pdf} -->
<!-- \includegraphics[width=2in]{figs/myfig2.pdf} -->

# Sensitivity to Model Specification

## Should we trust our model?

## Estimating all possible regressions

Idea

## Example 1

\large

>- "Great Recession" following global financial crisis of 2008-2009 ("subprime mortage crisis")
>- Two big bills in US Congress to shore up US auto industry
>    - Auto Bailout:
>    - Cash for Clunkers:

\pause 

@moopowree13 estimate relationship between presence of auto factories and Congressional votes these 2 quasi-private, particularistic bills.

\pause 

Claim: Local econ interests at least on par with corporate campaign contributions, corporate lobbying, corporate public positions.

## @moopowree13

![First differences for predicted probabilities of member supporting the auto bailout, comparing member from industry district to one from non-industry district, setting other variables at their means.](figs/02-fd690dwFac.pdf){fig_align="center" height=80%}

## @moopowree13

![First differences between industry and non-industry district members' probabilities of supporting the bailout remain positive at any value of DW-NOMINATE score. Mean estimates represented by black discs; 95% confidence intervals for each contribution level represented by red vertical bars. Ticks across bottom represent (jittered) observed DW-NOMINATE scores for Democrats, Republicans, and party defectors.](figs/02-fd690dwDW.pdf){fig_align="center" height=80%}



## @moopowree13

![Industry presence coefficient always positive in Bailout vote logistic regressions. Coefficient densities with industry presence and DW-NOMINATE always included. Every combination of other variables included and excluded: contributions from Big 3 PAC, AFL-CIO PAC, AFIT-PAC, Auto Dealers PAC, Foreign Auto Dealers PAC, Auto Dealers and Drivers PAC, Transit Union Workers PAC. PAC contributions logged. Panel title gives entire range of coef SEs.](figs/02-bailoutLogDWall.pdf){fig_align="center" height=80%}

## @moopowree13

![Industry presence coefficient always positive in Cash for Clunkers vote logistic regressions. Coefficient densities with industry presence and DW-NOMINATE always included. Every combination of other variables included and excluded: contributions from Big 3 PAC, AFL-CIO PAC, AFIT-PAC, Auto Dealers PAC, Foreign Auto Dealers PAC, Auto Dealers and Drivers PAC, Transit Union Workers PAC. PAC contributions logged. Panel title gives entire range of coef SEs.](figs/02-clunkersLogDWall.pdf){fig_align="center" height=80%}

## Implementation

@hebbali24

```{r}
library(olsrr)
```


## Example 2

```{r}
library(qss)
data(social)

social <- social |> mutate(
  age = 2006 - yearofbirth,
  age_c = age - mean(age),
  messages = fct_relevel(messages, "Control")
)

head(social)
```

## Example 2

```{r}
#| cache: true

lm_out <- lm(primary2006 ~ messages + sex + age_c +
               primary2004 + hhsize, data = social)

all_lm_social <- ols_step_all_possible(lm_out)$result

```

## Example 2

```{r}
all_lm_social_coefs <- ols_step_all_possible_betas(lm_out)

all_lm_social_coefs
```

## Example 2

```{r fig.height=5}
#| label: fig-coefs-neighbors
#| echo: false
#| fig-cap: "Coefficients from All Possible Regressions"

coefs_neighbors <- all_lm_social_coefs |> filter(predictor == "messagesNeighbors")

ggplot(coefs_neighbors, aes(beta)) + geom_histogram() + 
  labs(x = "Coefficient on 'Neighbors' Message")
```

```{r}
#| echo: false
summary(coefs_neighbors$beta)
```

## All Coefficients

```{r}
#| label: fig-coefs-all-neighbors
#| echo: false

ggplot(all_lm_social_coefs, aes(x = beta)) + geom_density() + 
  facet_wrap(~ predictor, scales = "free") +
  scale_x_continuous(labels = label_number(0.001))
```

## Matching as Preprocessing

\large 

- minimize effects of model-based adjustment (subclassify, match)

"model-based adjustments \ldots will give basically the same point estimates"

\pause 

What does this mean?

## @hoimakin07

"Matching as Nonparametric Preprocessing for Reducing Model Dependence in Parametric Causal Inference"

![Here](figs/02-hiks-model-dep.png)



***

![Here](figs/02-hiks-fda.png)

## How to Identify Problem?

Different distributions; non-overlap

![](figs/02-hiks-qq-candviz.png){fig-align="center" height=80%}

***

![](figs/02-hiks-candviz.png)


## Paradox of Regression for causal inference?

\large 

- If diffs large, regression not enough, very sensitive

- If diffs small, regression won't matter much 

- @hoimakin07

## Matching as Preprocessing for Dynamic Treatment Regimes

@blastr22 

# Sensitivity to an Unidentifiable Parameter

## Mediation Analysis

Confounding in Observational Studies

```{r warning = FALSE}
#| echo: false
coords <- list(x = c(T = 0, X = 1, Y = 2, M = 1),
               y = c(T = 1, X = 0, Y = 1.1, M = 1.5))
dagify(Y ~ T + M, T ~ X, Y ~ X, M ~ T, coords = coords) |>
  ggdag_classic(size = 30) + theme_dag_blank()
```

## Mediation Effects

\Large

>- If interest is $M \to Y$, seek experiment-like $M$
>    - random $M$
>    - subclassify/match for $M$
>    - instrumented $M$
>    - RDD, synthetic control for $M$
>- If interest is $T \to Y$, seek experimental $T$
>    - random $T$
>    - subclassify/match for $T$
>    - instrumented $T$
>    - RDD, synthetic control for $T$
>- In _mediation_, interest is $T \to M \to Y$
>    - (and maybe $T \to (\lnot M) \to Y$)


## Mediation Effects

\Large

Condition on /control for $M$?

\pause

>- No: how to estimate $M \to Y$?
>- Yes: induces _post-treatment bias_ in estimate of $T \to Y$

\pause

>- And if $X \to M$, too?
>- Even worse \ldots

***

```{r warning = FALSE}
#| echo: false
coords <- list(x = c(T = 0, X = 1, Y = 2, M = 1.1),
               y = c(T = 1, X = 0, Y = 1.1, M = 1.5))
dagify(Y ~ T + M, T ~ X, Y ~ X, M ~ T + X, coords = coords) |>
  ggdag_classic(size = 30) + theme_dag_blank()
```


## Addressing Confounding

\Large

To break confounding,

>- can't break $X \to Y$
>- break $X \to T$
>- but $X \to M$ may still remain!

<!-- # Post-Treatment Bias -->

<!-- ## Post-Treatment Bias -->

<!-- <!-- \note{ --> -->
<!-- <!--   \begin{itemize} --> -->
<!-- <!--   \item Assumption: randomized experiment, no bias from --> -->
<!-- <!--     self-assignment to treatment --> -->
<!-- <!--   \item Assumption: perfect compliance --> -->
<!-- <!--   \item Plot: (Pr(Lung Cancer) $\sim$ smoking status) --> -->
<!-- <!--   \end{itemize} --> -->

<!-- - Interest in effect of news on attitude. \pause  Randomly assign news: -->
<!-- ```{r warning = FALSE} -->
<!-- n <- 200 -->
<!-- news <- sample(0:1, n, rep = TRUE) -->
<!-- ``` -->

<!-- ## Post-Treatment Bias -->

<!-- - News status greatly affects Anxiety: -->

<!-- ```{r warning = FALSE, fig.height=4.5, echo=TRUE} -->
<!-- pr.anx <- 1/(1 + exp(-(news * 2 + rnorm(n)))) -->
<!-- ``` -->
<!-- \pause  -->
<!-- ```{r warning = FALSE, fig.height=4, echo=FALSE} -->
<!-- pt <- tibble(news, pr.anx) -->
<!-- ggplot(pt, aes(news, pr.anx, group = news)) + geom_boxplot() + labs(x = "News", y = "Anxiety") -->
<!-- ``` -->

<!-- ## Post-Treatment Bias -->

<!-- - News status greatly affects Anxiety: -->

<!-- ```{r} -->
<!-- summary(lm(pr.anx ~ news))$coef |> round(3) -->
<!-- ``` -->

<!-- <!-- \vspace{-3mm} --> -->
<!-- <!--  \begin{center} --> -->
<!-- <!--  \includegraphics[angle=0, width=2.2in]{../figs/ptTrend} --> -->
<!-- <!--  \end{center} --> -->


<!-- ## Post-Treatment Bias -->

<!-- <!-- \note{ --> -->
<!-- <!--   \begin{itemize} --> -->
<!-- <!--   \item (linear predictor of) mortality is function of Tr,  --> -->
<!-- <!--   \item Whether you're nonsmoker or smoker, lung cancer --> -->
<!-- <!--     incr. mortality --> -->
<!-- <!--     \item But {\it clearly}, smokers more likely to get LC, and have higher mortality --> -->
<!-- <!--   \end{itemize} --> -->
<!-- <!-- } --> -->

<!-- >- Anxiety greatly increases (negative) attitude -->
<!-- >    - (but news also has other ways to increase negative attitude) -->

<!-- \pause  -->

<!-- ```{r warning = FALSE} -->
<!-- attitude <- .1 * news + pr.anx + rnorm(n, sd = 0.2) -->
<!-- ``` -->

<!-- ```{r warning = FALSE, echo = FALSE} -->
<!-- pt <- tibble(news, pr.anx, attitude) -->
<!-- ``` -->

<!-- \pause  -->

<!-- ```{r warning = FALSE, message = FALSE, echo = FALSE, fig.height=4} -->
<!-- ggplot(pt, aes(pr.anx, attitude)) + geom_point() + geom_smooth() + facet_wrap(~ news) -->
<!-- ``` -->

<!-- <!-- \vspace{-3mm} --> -->
<!-- <!--  \begin{center} --> -->
<!-- <!--  \includegraphics[angle=0, width=2.6in]{../figs/ptBias} --> -->
<!-- <!--  \end{center} --> -->



<!-- ## Post-Treatment Bias -->

<!-- \large -->

<!-- <!--   \begin{itemize} --> -->
<!-- <!--   \item Analysis 1: no effect of smoking!! --> -->
<!-- <!--   \item Analysis 2: clear effect of smoking --> -->
<!-- <!--     ($1.4\sigma_y^{\text{controls}}$) --> -->
<!-- <!--   \item Note: Tr was randomly assigned!  I have no other confounders. --> -->
<!-- <!--     If Tr {\it nonrandomly} assigned, I have all the usual obs. study --> -->
<!-- <!--     problems, plus possibility of post-treatment bias. --> -->
<!-- <!--   \end{itemize} --> -->

<!-- >- Interested in causal effect of news on attitude -->
<!-- >- Analysis 1: Adjust for anxiety status: -->

<!-- \pause  -->

<!-- ```{r warning = FALSE} -->
<!-- summary(lm(attitude ~ news + pr.anx))$coef |> round(4) -->
<!-- ``` -->

<!-- <!--             Estimate Std. Error t value Pr(>|t|)     --> -->
<!-- <!-- (Intercept)  0.04955    0.06152   0.805    0.423     --> -->
<!-- <!-- smoke        0.03881    0.05348   0.726    0.470     --> -->
<!-- <!-- pr.lc        0.95007    0.11028   8.615  1.3e-13 *** --> -->

<!-- \pause -->

<!-- >- Great! Now, say, multiply coefs, to get $T \to M \to Y$? -->
<!-- >- Problem: This doesn't work. -->

<!-- ## Post-Treatment Bias -->

<!-- \large -->

<!-- <!--   \begin{itemize} --> -->
<!-- <!--   \item Analysis 1: no effect of smoking!! --> -->
<!-- <!--   \item Analysis 2: clear effect of smoking --> -->
<!-- <!--     ($1.4\sigma_y^{\text{controls}}$) --> -->
<!-- <!--   \item Note: Tr was randomly assigned!  I have no other confounders. --> -->
<!-- <!--     If Tr {\it nonrandomly} assigned, I have all the usual obs. study --> -->
<!-- <!--     problems, plus possibility of post-treatment bias. --> -->
<!-- <!--   \end{itemize} --> -->

<!-- >- Interested in causal effect of news on attitude -->
<!-- >- Analysis 2: Don't control for anxiety status: -->

<!-- \pause  -->

<!-- ```{r warning = FALSE} -->
<!-- summary(lm(attitude ~ news))$coef |> round(4) -->
<!-- ``` -->

<!-- <!-- > summary(lm(lp.mort ~ smoke)) --> -->
<!-- <!--             Estimate Std. Error t value Pr(>|t|)     --> -->
<!-- <!-- (Intercept)  0.52174    0.03694   14.13  < 2e-16 *** --> -->
<!-- <!-- smoke        0.37395    0.04850    7.71 1.05e-11 *** --> -->

<!-- \pause -->

<!-- >- Great! Now, say, subtract coef Analysis 1 from this, to get $T \to M \to Y$? -->
<!-- >- Problem: This doesn't work. -->

<!-- ## Post-Treatment Bias -->

<!-- <!-- The roughest, rawest advice.\\ --> -->
<!-- <!-- {\bf Draw the Tr timing arrow.} --> -->

<!-- If you want the effect of $T$ on $Y$, -->

<!-- \begin{itemize} -->
<!-- \item Match/adjust for (pre-treatment) covariates -->
<!-- \item Don't match/adjust for other (post-treatment) quantities -->
<!-- \end{itemize}  -->

<!-- \pause -->

<!-- If I'm not sure about the causal ordering, can I just try both? -->
<!-- \pause  -->

<!-- Idea: -->

<!-- >- Estimate $Y_i = \beta_0 + \beta_1 T_i + \epsilon_i$ -->
<!-- >- Estimate $Y_i = \delta_0 + \delta_1 T_i + \delta_2 X_i + \nu_i$ \pause  -->

<!-- Problem: -->

<!-- >- These 2 estimates of TE **don't** bound the truth. -->
<!-- >- $ATE \stackrel{?}{\in} [\hat{\beta}_1, \hat{\delta}_1 ]$ \pause  We don't know! -->

<!-- ## Post-Treatment Bias -->

<!-- \large -->

<!-- >- Think really hard about design. -->
<!-- >- Some ideas -->
<!-- >    - Redefine the treatment (audit studies) -->
<!-- >    - Find a valid instrument/discontinuity/milestone/opportunity -->
<!-- >    - Plan an experiment -->
<!-- >    - Plan several experiments -->



<!-- ## Mediation -->

<!-- <!-- In the example, --> -->
<!-- <!-- \begin{itemize} --> -->
<!-- <!-- \item Treatment: smoking --> -->
<!-- <!-- \item Mechanism/mediator: lung cancer \pause  --> -->
<!-- <!-- \item Key: we've shown that even if $T$ randomized, adjusting for $M$ gives biased --> -->
<!-- <!--   estimate of causal effect \pause  --> -->
<!-- <!-- \item Ok, I want effect of smoking on mortality that {\it goes --> -->
<!-- <!--     through} lung cancer --> -->
<!-- <!-- \end{itemize} --> -->




<!-- ## Mediation Exercise -->

<!-- <!-- \note{ --> -->
<!-- <!-- Not just direction. --> -->
<!-- <!-- \begin{enumerate} --> -->
<!-- <!-- \item Reminds voter of election day; heightens sense of party-team --> -->
<!-- <!--   identity --> -->
<!-- <!-- \item Kids can focus in class; nicer groceries and kids eat better --> -->
<!-- <!-- \item Make opponent look supportive of outgroup; heighten fear of --> -->
<!-- <!--   fiscal armeggedon --> -->
<!-- <!-- \end{enumerate} --> -->
<!-- <!-- } --> -->

<!-- Describe two mechanisms through which -->

<!-- \begin{enumerate} -->
<!-- \item a GOTV prompt could increase turnout -->
<!-- \item neighborhood safety could increase GPA -->
<!-- \item a political attack advertisement could increase propensity to vote for -->
<!--   anti-welfare state candidate -->
<!-- \end{enumerate} -->

<!-- \pause -->
<!-- \vspace{3mm} -->

<!-- Mediation analysis tries to estimate _how much_ effect of $T$ on -->
<!-- $Y$ goes through $M$. -->



## Notation

<!-- <!-- \note{ --> -->
<!-- <!-- (Assuming perfect compliance.) --> -->

<!-- <!-- \begin{itemize} --> -->
<!-- <!-- \item Q: Is $M_i(t)$ a potential outcome?\\ --> -->
<!-- <!-- \item[] A: Yes.  Fixed, value revealed based on $t$. --> -->
<!-- <!-- \item Quiz: --> -->
<!-- <!-- \begin{itemize} --> -->
<!-- <!--   \item what's $Y_i(1, M_i(1))$?  mortality would obs given smoking and LC you'd --> -->
<!-- <!--     get under smoking. --> -->
<!-- <!--    \item what's $Y_i(0, M_i(0))$? mortality would obs given nonsmoking and LC --> -->
<!-- <!--      you'd get under nonsmoking.  ($M_i(0)$ may $=1$: still get LC.) --> -->
<!-- <!--   \item what's $Y_i(1, M_i(1)) - Y_i(0, M_i(0))$?   Total mortality --> -->
<!-- <!--     difference would obs. for $i$ under smoking minus $i$ under nonsmoking, just --> -->
<!-- <!--     letting LC vary as it will under each assg. --> -->
<!-- <!--     \item what's $Y_i(1, M_i(0))$?  mortality would obs under smoking, but LC --> -->
<!-- <!--       value from nonsmoking.  (Jason...)  (Imagine randomizing LC values.) --> -->
<!-- <!-- \end{itemize} --> -->
<!-- <!-- \end{itemize} --> -->
<!-- <!-- } --> -->

<!-- <!-- %Welcome back to ``compliance''.  \pause You know this can --> -->
<!-- <!-- %clarify underlying ideas.  \pause  --> -->

\begin{itemize}
\item $M_i(t)$: value of the mediator (function of treatment) \pause
\item $Y_i(t,m)$: potential outcome under some combination of $t$, $m$
  \pause
\item $Y_i(T_i, M_i(T_i))$: potential outcome under
  \begin{itemize}
  \item $T_i = t$
  \item $M_i$ you would get with $T_i=t$
  \end{itemize} \pause
\item Quiz: \pause  In news/anxiety/attitude example,
  \begin{itemize}
  \item what's $Y_i(1, M_i(1))$?
   \item what's $Y_i(0, M_i(0))$?
  \item what's $Y_i(1, M_i(1)) - Y_i(0, M_i(0))$?
  \item what's $Y_i(1, M_i(0))$?
  \end{itemize}
\end{itemize}


## Notation: Causal Effects

<!-- <!--   \begin{itemize} --> -->
<!-- <!--   \item Mediation effects: hold Tr/Co constant, manipulate mediator --> -->
<!-- <!--   \item Direct effects: hold mediator constant, manipulate --> -->
<!-- <!--     Tr/Co. (``zeta'') --> -->
<!-- <!-- \item Note: Plural -- ``effectS'' --> -->
<!-- <!-- \item Immig -- Mediation: effect of changing anxiety on opinion (for fixed --> -->
<!-- <!--   Tr status). --> -->
<!-- <!-- \item Immig -- Direct: effect of exposure on opinion, holding anxiety fixed. --> -->
<!-- <!--   \end{itemize} --> -->

For individuals:
\begin{itemize}
\item $Y_i(1, M_i(1)) - Y_i(0, M_i(0))$: Total effect \pause
\item $Y_i(0, M_i(1)) - Y_i(0, M_i(0)) \equiv \delta_i(0)$:
  Indirect/Mediation effect under Co
\item $Y_i(1, M_i(1)) - Y_i(1, M_i(0)) \equiv \delta_i(1)$:
  Indirect/Mediation effect under Tr  \pause
\item ACMEs: $\bar{\delta}(1)$ and $\bar{\delta}(0)$ \pause
\item $Y_i(1, M_i(0)) - Y_i(0, M_i(0))\equiv \zeta_i(0)$: Direct
  effect of Tr on $Y$,\\ under mediator value as if control
\item $Y_i(1, M_i(1)) - Y_i(0, M_i(1))\equiv \zeta_i(1)$: Direct
  effect of Tr on $Y$,\\ under mediator value as if treated \pause
\item ADEs: $\bar{\zeta}(1)$ and $\bar{\zeta}(0)$ \pause
\end{itemize}

<!-- ## Notation: Causal Effects -->

<!-- \large  -->

<!-- - Let $T=$ randomized exposure to immigration news -->
<!-- - Let $M=$ anxiety -->
<!-- - Let $Y=$ opinion on immigration \pause -->


<!-- - Describe the mediation effects -->
<!-- - Describe the direct effects -->


<!-- ## Moderation and Interaction -->


<!-- <!--   \item 3rd vars:  primary interest is relationship betwn $T --> -->
<!-- <!--     \Rightarrow Y$.  Mod/meds are related to this relationship, but --> -->
<!-- <!--     not $T$ or $Y$. --> -->
<!-- <!--   \item MEDiators fall betwn $T$ and $Y$, are affected by $Y$.  Are --> -->
<!-- <!--     ``mechanisms'', ``pathways''.  Mediation analysis: how much of --> -->
<!-- <!--     effect of $T$ goes through this mechanism? --> -->
<!-- <!--  \item MODerators are pretreatment covariates, but they affect not --> -->
<!-- <!--    just {\it level} of $Y_i$ observed (``confounders''), but also size --> -->
<!-- <!--    of $TE_i$ --> -->
<!-- <!-- \item I.e., controlling for confounders reduces bias in estimate of, --> -->
<!-- <!--   e.g., ATE. --> -->
<!-- <!-- \item[]  Moderation means we have {\it multiple} causal estimates, one --> -->
<!-- <!--   for each level of moderator. --> -->

<!-- >- Moderators and mediators are both ``third variables\text{''} -->
<!-- >- First, our DAG model for mediation: -->

<!-- \pause  -->

<!-- \begin{center} -->
<!-- \includegraphics[angle=0, width=2in]{figs/08-iktyMedModel.jpg} -->
<!-- \end{center}  -->
<!-- \pause  -->

<!-- >- What's "moderation"? -->
<!-- >    - When $E(Y_i(1) - Y_i(0) | X = x_1) \neq E(Y_i(1) - Y_i(0) | X -->
<!--     = x_2)$ -->
<!-- >    - When there are ``heterogeneous treatment effects\text{''} -->
<!-- >    - When there is an ``interaction between $T$ and $X$\text{''} -->



<!-- ## What does Moderation Look Like? -->

<!-- <!-- \begin{center} --> -->
<!-- <!--   See {\tt moderation.R}. --> -->
<!-- <!-- \end{center} --> -->

<!-- <!-- \pause  --> -->

<!-- \large  -->

<!-- Notes on interactions: -->

<!-- >- If they are in DGP, omitting can lead to terrible estimates -->
<!-- >    - Include in $p$-score models -->
<!-- >- Ignore stat. sig. of ``main\text{''} linear terms   -->
<!-- [@braumoeller04] -->
<!-- >- Don't fish! -->


<!-- <!-- ``Indirect effect'' definition less clear here than in mediation --> -->

<!-- <!-- If offensive, just think ``mediator causal effect''. --> -->




## Are 2 Experiments Enough for Mediation CEs?

\begin{itemize}
\item Exp. 1: Randomize $T_i$, measure $M_i$, get ``ACE of $T$ on
  $M$'' \pause
\item Exp. 2: Randomize $M_i$, measure $Y_i$, get ``ACE of $M$ on
  $Y$'' \pause
\item Then, combine somehow, get ACME/Indir. effect of $T$ on $Y$ via $M$?
\pause
\item But, this doesn't get you
  \begin{itemize}
  \item Unbiased estimate \pause
  \item Sign of ACME \pause
  \item Informative bounds for ACME!
  \end{itemize}
\end{itemize}


## Usual (Best-Case?) Way to "Combine Somehow"

"Baron & Kenny Procedure"

\begin{eqnarray}
 M_i  & = & \alpha_1 + a T_i + \epsilon_{i1} \\
 Y_i  & = & \alpha_2 + c T_i + \epsilon_{i2} \\
 Y_i  & = & \alpha_3 + d T_i + bM_i + \epsilon_{i3}
\end{eqnarray}

\pause
(Can add $+ {\bf e}_1 X_i$, $+ {\bf e}_2 X_i$, $+ {\bf e}_3 X_i$.)

\pause

Then, call effect of
\begin{eqnarray*}
T \to M & = & a \\
T \to Y & = & c \qquad \qquad \text{(Total)}\\
T \to Y & = & d \qquad \qquad \text{(Direct)}\\
  M \to Y & = & b \\
T \to M \to Y & = & c-d = ab \qquad
\text{(Mediation)}
\end{eqnarray*}

\pause

Problem: This doesn't work.


## Why Aren't 2 Experiments Enough?

<!-- <!-- \note{Consider table. --> -->
<!-- <!--   \begin{itemize} --> -->
<!-- <!--   \item Imagine pop with 4 types of people --> -->
<!-- <!--   \item Imagine see all potential outcomes (cols 2-5) --> -->
<!-- <!-- \item Imagine Tr only affects $Y$ through $M$ediator --> -->
<!-- <!-- \item Calculate avg pot. outcomes for various $t$, $m$ (last row) --> -->
<!-- <!-- \item Then, easy to do subtraction, calculate effects of $T$ on $M$, --> -->
<!-- <!--   $M$ on $Y$ (the ``2 experiments'') --> -->
<!-- <!-- \item Also easy to calc. each type's Mediation effect, and average.   --> -->
<!-- <!-- \item Clearly, product/difference of Baron-Kenny regression coefs is wrong! --> -->
<!-- <!--   \end{itemize} --> -->

![](figs/02-iktySItable.jpg)

\pause

\begin{tabular}{lcccc}
$T \to M$ & $=$ & $a$ & $=$ &0.2 \\
$M \to Y$ & $=$ & $b$ & $=$ &0.2 \\
$T \to M \to Y$ & $=$ & $ab$ & $=$ & 0.04
\end{tabular}

\pause

\vspace{1mm}
But, true $\bar{\delta}(t)$, ACME, $=-0.2$!



## What Else Do You Need?

Consistency assumption:  $T_i = t$, $M_i = m$ have same effect
regardless of how they came to have those values.

\pause
\vspace{3mm}

(Using lottery to estimate effect of income on attitude requires
**lottery income**  to have same effect as **regular income**.)

\pause
\vspace{3mm}

The ACME, e.g., is an estimate of the effect of changes in $M$ due to changing
$T$ (but without changing $T$).

\pause
\vspace{3mm}

(Other manipulations of $M$ rely on consistency.)



## What Else Do You Need?

Big picture: to get more detailed estimates from same data, need more assumptions

![](figs/02-iktySeqIgnor.jpg)


## What Else Do You Need?

- Eqn 3: Conditional independence of PotOut's from Tr, given $X$ (pretreatment!)
    - Ok, for random $T$, or balanced obs design.  $T$ as good as random, exog., etc.
    - ($t'$ is just saying, for each $t=0,1$, must have $Y$'s from both
$t=0,1$ must be indep.)
- Eqn 4: Hard.  Mediator is as good as random, given particular Tr
  status
- Problem: can't randomize _both_ $T$ and $M$ in same experiment
    - (if want effect of $T$ through $M$)
- You're getting 2 different QoI's if you randomize both: $T \to M, Y$ and $M
  \to Y$.
    - Showed can't combine those into $T \to M \to Y$

<!-- ## When Can You Get It? -->

<!-- <!-- \begin{itemize} --> -->
<!-- <!-- \item Problem: $T$ may affect $N$ which may affect $M$  --> -->
<!-- <!-- \item[] What about matching/adjusting for $N$?  (No, it's post-Tr!) --> -->
<!-- <!-- \item[] In (3), need to adjust for $X$ sometimes -- get balance, find rand. experiment --> -->
<!-- <!-- \item[] But, in (4), adjusting for $X$ not enough -- may have --> -->
<!-- <!--   imbalance on $N$.  If don't adjust, it's like bad obs. study.  If do --> -->
<!-- <!--   adjust, it's like obs. study with post-treatment bias. --> -->
<!-- <!-- \item E.g., random ImmigNews.  Knowing $T$ doesn't tell $Y$, $M$ --> -->
<!-- <!--   values. --> -->
<!-- <!-- \item[] But, if ImmigNews affects both anxiety $M$ and issueAwareness --> -->
<!-- <!--   $N$, and issueAwareness affects anxiety $M$, you're in deep. --> -->
<!-- <!-- \item Can't even get sensitivity analysis here. --> -->
<!-- <!--   \end{itemize} --> -->


<!-- \begin{center} -->
<!--  \includegraphics[angle=0, width=4.5in]{figs/08-iktyMedProblem.jpg} -->
<!-- \end{center} -->



<!-- ## Estimating Mediation Effects -->

<!-- <!--   \begin{itemize} --> -->
<!-- <!-- \item Generally, combination of model outputs\\ --> -->
<!-- <!-- (quasi-Bayes Monte Carlo draws of model --> -->
<!-- <!--     parameters procedure) --> -->
<!-- <!--   \item BK procedure, using {\tt lm()} is example. --> -->
<!-- <!--   \item But estimation doesn't ensure good answer! --> -->
<!-- <!--   \item Sensitivity {\it as part of} results summary --> -->
<!-- <!--   \end{itemize} --> -->


<!-- \begin{itemize} -->
<!-- \item Subtlety: $\exists$ causal DAG's for which -->
<!--     sensitivity of ACME can be est'd; even some with ACME identified. \pause -->
<!-- \item However, must convince that $\nexists$ $N \to M$, whether or not $N$ observed.  \pause -->
<!-- \item Practical advice: start there.  \pause  Then, -->

<!-- \begin{center} -->
<!-- \includegraphics[angle=0, width=3in]{figs/08-iktyMedSoftware.jpg} -->
<!-- \end{center} -->
<!-- \end{itemize} -->

<!-- (From \href{http://imai.princeton.edu/research/files/mediationR.pdf}{here}.) -->

<!-- ## Sensitivity for Mediation Effects -->


<!-- <!-- Sensitivity:  ``How bad would it have to be to change my answer?'' --> -->

<!-- Given -->
<!-- \begin{eqnarray} -->
<!-- M_i  & = & \alpha_1 + a T_i + \epsilon_{i1} \\ -->
<!-- Y_i  & = & \alpha_2 + c T_i + \epsilon_{i2} \\ -->
<!-- Y_i  & = & \alpha_3 + d T_i + bM_i + \epsilon_{i3} -->
<!-- \end{eqnarray} -->

<!-- \begin{itemize} -->
<!-- \item Q: How much covariance $\rho$ is there between $\epsilon_{i1}$ and -->
<!--   $\epsilon_{i3}$? \pause -->
<!-- \item A: If Seq. Ig. is true, then none ($X$-adjustment does its job) \pause -->
<!-- \item[] (If $P$, then $Q$.)  \pause -->
<!-- \item If $\rho \neq 0$, then Seq. Ig. is false (likely hidden -->
<!--   confounder) \pause -->
<!-- \item[] (If $\lnot Q$, then $\lnot P$.) \pause -->
<!-- \item[] (I.e., From freq. standpoint, you can find ``evidence of problem'', or ``no evidence -->
<!--   of problem'', but not ``evidence of no problem''.) -->
<!-- \end{itemize} -->

## Sensitivity for Mediation Effects

<!-- <!--   \begin{itemize} --> -->
<!-- <!-- \item Estimate of mediation effect: dashed line. --> -->
<!-- <!--   \item Problem: {\it True} value of $\rho$ unknown (``errors'', not --> -->
<!-- <!--     ``residuals'') --> -->
<!-- <!--   \item So, have to propose range of $\rho_0$ values,\\ figure out: ``given --> -->
<!-- <!--     our obs. data $+ \rho_0$, what would true ACME be?'' --> -->
<!-- <!--   \item Note: This sensitivity is {\it only} to unobserved --> -->
<!-- <!--     pretreatment $X$ confounding --> -->
<!-- <!-- \item If $\rho=0$, estimated ACME is true. --> -->
<!-- <!-- \item[] If $\rho =.5$, estimated ACME is off from 0 (and big --> -->
<!-- <!--   overestimate) --> -->
<!-- <!-- \item[] If $\rho =-.75$, estimated ACME is off from truth (and big --> -->
<!-- <!--   underestimate) --> -->
<!-- <!--   \end{itemize} --> -->

![](figs/02-iktyMedSens.jpg)


<!-- ## Design for Mediation Effects -->

<!-- @imakeetin11 -->

<!--   <!-- \item Random $T$, measure $M$, measure $Y$ --> 
<!--   <!-- \item Media cues {\it encourage} emotional changes -->
<!--   <!-- \item Parallel: 1) single-exp, 2) another encouragement of emotion --> 
<!--   <!--   change (writing task).  (But, still not ID'ed, relying on --> 
<!--   <!--   assumptions.) --> 
<!--   <!-- \item Combine Parallel with IV, identify the CACME.\\(I.e., get some --> 
<!--   <!--   random variation in $M$ for both the Tr and Co condition subjects) --> 



<!-- \begin{itemize} -->
<!-- \item Single experiment -->
<!-- \item Encouragements-of-mediator experiments -->
<!-- \item Parallel encouragement experiments -->
<!-- \item Parallel encouragement with IV: CACME -->
<!-- \end{itemize} -->



## Summary

- Be careful.  \pause  If you estimate, you must do sensitivity. \pause
    - A serious case of ``don't just get an answer\text{''} \pause
    - (Do `plot(lm_out)`, too \ldots) \pause
- @imakeetin11 thorough on assumptions, when trouble, when
  sensitivity is OK, when identification can be done\pause
- From @bulgreha10:

![](figs/02-bghMedQuote.jpg)



# Sensitivity to an Unobserved Covariates

## Confounding in Observational Studies

```{r warning = FALSE, echo = FALSE}
coords <- list(x = c(T = 0, X = 1, Y = 2), 
               y = c(T = 1, X = 0, Y = 1.1))
dagify(Y ~ T, T ~ X, Y ~ X, coords = coords) |> 
  ggdag_classic(size = 30) + theme_dag_blank()
```

***

```{r dagUnobs, warning=FALSE, echo=FALSE}
coords <- list(x = c(T = 0, X = 1, Y = 2, U = 0.1), 
               y = c(T = 1, X = 0, Y = 1.1, U = 0.1))
dagify(Y ~ T + U, T ~ X + U, Y ~ X, coords = coords, latent = "U") %>% 
  ggdag_classic(size = 30) + theme_dag_blank()
```

## Addressing Confounding

\Large 

To break confounding, 

- can't break $X \to Y$
- break $X \to T$
- I.e., make $X \independent T$
- But this doesn't address $U \to T$ (or $U \to Y$).

\pause 

(Of course, if no causal effect of $U \to Y$, no problem.)


## Hidden Bias

\large 

Where there is $U \to T$ and $U \to Y$, there is _hidden bias_.  

\pause 

Formally, $i$ and $j$ appear similar: $$\mathbf{x}_i = \mathbf{x}_j$$ 

\pause 

but are different in prop score: $$\pi_i \neq \pi_j$$ 


## Example

\large

We are interested in the effect of phone calls on turnout.  

\pause 

Two voters look identical on observed predictors of whether called (that might affect 
turnout, too): age, education, income, party ID.  

\pause 

However, **different** probabilities of being called, due to unobserved confounder, sociability.

\pause 

Sociability affects whether called (know more people) and turnout.

\pause 

Sensitivity: how strong must sociability be to invalidate inference about phone calls?

<!-- # Odds -->

## Odds

The _odds_ of $A_1$ vs. $A_2$ is $$A_1:A_2 = \frac{p(A_1)}{p(A_2)}$$ \pause

Odds often expressed as 

- integers: $3:2$  \pause Know $p(\Omega)=1$, so 
$$3:2 = \frac{.6}{.4}$$  \pause
- base $=1$: $1.5:1$.  \pause Know $p(\Omega)=1$, so 
$$1.5:1 = \frac{.6}{.4}$$ 

## Odds Ratios

An _odds ratio_ is \pause a ratio of odds: \pause 

$$OR = \frac{\left(\frac{p(A_1)}{p(A_2)} \right)}{\left(\frac{p(A_3)}{p(A_4)}\right)}$$ 

\pause 

The strength, and weakness, is comparing changes from different base rates.  

\pause 

\vspace{5mm} From base odds of $1:1$, say a change of condition produces odds ratio of 3. \pause 
$$\frac{\frac{.03}{.01}}{\frac{.01}{.01}} \pause =
\frac{\frac{.06}{.02}}{\frac{.02}{.02}} \pause = 
\frac{\frac{.9}{.3}}{\frac{.3}{.3}} \pause = 
\frac{\frac{.9}{.3}}{\frac{.9}{.9}} \pause = \ldots$$


## Application: Measuring Group Differences (JP Scanlon)

\begin{center}
\begin{tabular}{ccccccc}
& \multicolumn{3}{c}{\% Below Pov Line} & \multicolumn{3}{c}{\% Above
  Pov Line} \\
& B & W & $\frac{B}{W}$ & B & W & $\frac{B}{W}$ \\ \hline
$t_1$ & 90 & 80 & 1.1 & 10 & 20 & 0.5 \\ \pause
$t_2$ & 15 & 5 & 3.0 & 85 & 95 & 0.89
\end{tabular}
\end{center} \pause

\pause 

>- At $t_1$: More blacks below, whites above PovLine
>- At $t_2$: are things getting better or worse for Blacks relative to Whites?

\pause 

Clearly, worse (odds of below pov line):  

Odds Ratios: $\frac{1.1}{.5} = 2.2$, $\frac{3}{.89} = 3.4$

\pause 

Clearly, no change:    

Absolute Differences: 10, 10, 10, 10  

\pause 

Clearly, huge absolute improvements.

## Application: Measuring Group Differences (JP Scanlon)

>- Key: it's not clear whether relative disparities getting better/worse/neither by below/above measures.
>- (Easy to produce examples of OR's same and AbsDiffs slightly diff.)
>- (Diffs betwn groups real, importnt, but how we meas. changes is tricky)

	
## King's Conjecture

<!-- (Unproven; not proven false) -->

\begin{center}
\includegraphics[angle=0, width=4.5in]{figs/02-gkOR-tweet.jpg}

\vspace{15mm}
17 October 2012

\end{center}


<!-- # Rosenbaum's Model -->

## Modeling Hidden Bias

\large

Odds of treatment for $i$ and $j$:

$$\frac{\pi_i}{1 - \pi_i}, \frac{\pi_j}{1 - \pi_j}$$

\pause

OR of $i$ versus $j$:

\begin{eqnarray*}
OR & = & \frac{\pi_i}{1 - \pi_i} \div \frac{\pi_j}{1 - \pi_j} \\
& = & \frac{\pi_i (1 - \pi_j)}{\pi_j (1 - \pi_i)}
\end{eqnarray*}


## Modeling Hidden Bias

\large

Let $\Gamma$ be upper bound on OR of treatment.

$$\frac{1}{\Gamma} \leq \frac{\pi_i (1 - \pi_j)}{\pi_j (1 - \pi_i)} \leq \Gamma \qquad \forall i, j \text{ s.t. } \mathbf{x}_i = \mathbf{x}_j$$

\pause

By what factor does the odds of treatment differ?  (No more than $\Gamma$)

## Modeling Hidden Bias

@rosenbaum20 shows that this is same as

\begin{eqnarray*}
\log \left(\frac{\pi_i}{1-\pi_i} \right) & = & \kappa(\mathbf{x}_i) + \gamma u_i \\
\log \left(\frac{\pi_j}{1-\pi_j} \right) & = & \kappa(\mathbf{x}_j) + \gamma u_j
\end{eqnarray*}

s.t. $0 \leq u_i \leq 1$.

\pause

Interpretation: first rewrite

$$\log \left(\frac{\pi_j}{1-\pi_j} \right) = \kappa(\mathbf{x}_i) + \gamma u_j$$

***

Exponentiate:

\begin{eqnarray*}
\left(\frac{\pi_i}{1-\pi_i} \right) & = & e^{\kappa(\mathbf{x}_i) + \gamma u_i} \\
\left(\frac{\pi_j}{1-\pi_j} \right) & = & e^{\kappa(\mathbf{x}_i) + \gamma u_j} \\
\end{eqnarray*}

\pause

Calculate OR:

\begin{eqnarray*}
OR & = & \frac{\pi_i (1 - \pi_j)}{\pi_j (1 - \pi_i)} \\
& = & \frac{e^{\kappa(\mathbf{x}_i) + \gamma u_i} }{ e^{\kappa(\mathbf{x}_i) + \gamma u_j} } \\
& = & e^{\left(\kappa(\mathbf{x}_i) + \gamma u_i \right) - \left( \kappa(\mathbf{x}_i) + \gamma u_j \right) } \\
& = & e^{\left(\gamma u_i - \gamma u_j \right) } \\
& = & e^{\gamma \left( u_i - u_j \right) }
\end{eqnarray*}

## Interpreting $\Gamma$

\large

$OR = e^{\gamma \left( u_i - u_j \right) }$

\pause

Log odds differ by factor of $\gamma$ times diff in unobs confounder.

\pause

Shows $\Gamma = e^{\gamma}$.


***

<!-- What is the test here?  RTM  -->

![](figs/02-sens-tab1.png)

\pause

<!-- \vspace{5mm} -->

- Groups: smokers/nonsmokers
- Outcome: lung cancer
- Something must increase smoking by $6 \times$ to change inference.
- If exists, maybe it's that factor, not smoking directly.

(Bias from $U \to T$; effectively, $U \to Y$ nearly perfect.)

***

<!-- | $\Gamma$ | Minimum       | Maximum       | -->
<!-- |--------|:--------:|:--------:| -->
<!-- | 1        | $\leq 0.0001$ | $\leq 0.0001$ | -->
<!-- | 2        | $\leq 0.0001$ |    0.0018     | -->
<!-- | 3        | $\leq 0.0001$ |    0.0136     | -->
<!-- | 4        | $\leq 0.0001$ |    0.0388     | -->
<!-- | 4.25     | $\leq 0.0001$ |    0.0468     | -->
<!-- | 5        | $\leq 0.0001$ |    0.0740     | -->

\begin{table}[ht]
    \centering
    % \caption{Example Table}
    \begin{tabular}{c|c|c}
    \hline
    $\Gamma$ & Minimum & Maximum \\
    \hline
    1        & $\leq 0.0001$ & $\leq 0.0001$ \\
    2        & $\leq 0.0001$ & 0.0018 \\
    3        & $\leq 0.0001$ & 0.0136 \\
    4        & $\leq 0.0001$ & 0.0388 \\
    4.25     & $\leq 0.0001$ & 0.0468 \\
    5        & $\leq 0.0001$ & 0.0740 \\
    \hline
    \end{tabular}
\end{table}

\vspace{5mm}

Table 4.2: Signed-Rank Statistic $p$-value Sensitivity for Lead in Children's Blood

- Groups: parents occupationally exposed/unexposed
- Outcome: children's levels
- Something must increase parents' exposure by $5 \times$ to change inference.
- If exists, maybe it's that, not parental exposure directly.

\pause

(one-sided)


***

<!-- | $\Gamma$ | Minimum | Maximum | -->
<!-- | -------- | ------- | ------- | -->
<!-- | 1        | 15      | 15      | -->
<!-- | 2        | 10.25   | 19.5    | -->
<!-- | 3        | 8       | 23      | -->
<!-- | 4        | 6.5     | 25      | -->
<!-- | 5        | 5       | 26.5    | -->

\begin{table}[ht]
    \centering
    % \caption{Example Table}
    \begin{tabular}{c|c|c}
    \hline
    $\Gamma$ & Minimum & Maximum \\
    \hline
    1        & 15      & 15      \\
    2        & 10.25   & 19.5    \\
    3        & 8       & 23      \\
    4        & 6.5     & 25      \\
    5        & 5       & 26.5    \\
    \hline
    \end{tabular}
\end{table}


\vspace{5mm}

Table 4.3: Point Estimate Sensitivity for Lead in Children's Blood

\pause

- HL point estimate: 15
(median of all $m \times n$ possible matched pairs)
- With confounding, wider range of possible effects.



***

<!-- | $\Gamma$ | 95% CI       | -->
<!-- | :------: | :----------: | -->
<!-- | 1        | (9.5, 20.5)  | -->
<!-- | 2        | (4.5, 27.5)  | -->
<!-- | 3        | (1.0, 32.0)  | -->
<!-- | 4        | (-1.0, 36.5) | -->
<!-- | 5        | (-3.0, 41.5) | -->

\begin{table}[ht]
    \centering
    % \caption{Example Table with 95\% Confidence Intervals}
    \begin{tabular}{c|c}
    \hline
    $\Gamma$ & 95\% CI \\
    \hline
    1        & (9.5, 20.5)  \\
    2        & (4.5, 27.5)  \\
    3        & (1.0, 32.0)  \\
    4        & (-1.0, 36.5) \\
    5        & (-3.0, 41.5) \\
    \hline
    \end{tabular}
\end{table}

\vspace{5mm}

Table 4.4: Confidence Interval Sensitivity for Lead in Children's Blood

\pause

- Inverted NHST CI's
- If something increases parental exposure by $4 \times$, negative
estimates of parents on children are reasonable.

(two-sided)


<!-- # Implementation -->

## Implementation

\Large

Packages

- @framarduo13: `konfound`
- @keele22: `rbounds`
- `sensitivitymw`
- `sensitivitymv`

## Example

```{r}
anes <- read_csv("../data/anes_pilot_2016.csv")
dim(anes)

anes <- anes |> mutate(age = 2016 - birthyr,
                       pid_rep = as.numeric(pid3 == 3),
                       pid_dem = as.numeric(pid3 == 1))
```

***

```{r}
lm_out <- lm(turnout12 ~ pid_rep, data = anes)
summary(lm_out)
```


***

```{r warning = FALSE, results = 'hide'}
#| echo: false
#| eval: true

hook_output = knit_hooks$get('output')
knit_hooks$set(output = function(x, options) {
  # this hook is used only when the linewidth option is not NULL
  if (!is.null(n <- options$linewidth)) {
    x = knitr:::split_lines(x)
    # any lines wider than n should be wrapped
    if (any(nchar(x) > n)) x = strwrap(x, width = n)
    x = paste(x, collapse = '\n')
  }
  hook_output(x, options)
})
```

```{r warning = FALSE, message=FALSE, linewidth=60, eval=FALSE}
library(konfound)
konfound(lm_out, pid_rep)
```

\pause


```{r warning = FALSE, message=FALSE, linewidth=60, echo=FALSE}
library(konfound)
konfound(lm_out, pid_rep)
```


***

```{r warning = FALSE}
lm_out <- lm(turnout12 ~ pid_rep + age, data = anes)
summary(lm_out)
```

***

```{r warning = FALSE, message=FALSE, linewidth=60}
konfound(lm_out, pid_rep)
```

***

```{r warning = FALSE}
cor(anes[,c("pid_rep", "turnout12", "econnow")])
```

***

```{r warning = FALSE}
lm_out <- lm(turnout12 ~ pid_rep + age + econnow, data = anes)
summary(lm_out)
```

***

```{r warning = FALSE, message=FALSE, linewidth=60}
konfound(lm_out, pid_rep)
```


## Implementation in `rbounds`

\large

```{r warning = FALSE, message=FALSE}
library(Matching)
data(GerberGreenImai)

# Estimate Propensity Score
pscore.glm <- glm(PHN.C1 ~ PERSONS + VOTE96.1 +
                    NEW + MAJORPTY + AGE + WARD +
                    PERSONS:VOTE96.1 + PERSONS:NEW +
                    AGE2, family = binomial(logit),
                  data = GerberGreenImai)
```

***

```{r warning = FALSE}
hist(pscore.glm$fitted)
```


## Implementation in `rbounds`

```{r warning = FALSE}
# Match - without replacement
m.obj <- Match(Y = GerberGreenImai$VOTED98,
               Tr = GerberGreenImai$PHN.C1,
               X = fitted(pscore.glm), M = 1, replace = FALSE)

summary(m.obj)
```


## Implementation in `rbounds`

```{r}
#| eval: true
library(rbounds)

# Sensitivity Test
# binarysens(m.obj, Gamma = 2, GammaInc = .1)
```

## Implementation in `rbounds`

```{r}
#hlsens(m.obj, Gamma = 5, GammaInc = 1)
```


***

\huge

\begin{center}
Thanks! 
\end{center}

\vspace{5mm}

\large

\begin{center}
\texttt{rtm@american.edu}  \\
\texttt{www.ryantmoore.org}  
\end{center}


## References {.allowframebreaks}

\footnotesize

